#!/bin/bash

#@file
#Installs/uninstalls Tomcat

# Checks
if [ -z $(which java) ]; then
  echo -e "\nYou need to install Java!\n"
  exit 1
fi

# Settings/Vars
major_v="7" #Defaults to lastest version of 7
minor_v="0.70"
v="${major_v}.${minor_v}"
t_dir="apache-tomcat-${v}"
t_file="${t_dir}.tar.gz"
tomcat_location="/Library/Tomcat"

# Uninstall Tomcat
if [ "${1}" == "destroy" ] || [ "${1}" == "rebuild" ]; then
  echo -e "\nUninstalling Tomcat.\n"

  # Checks if tomcat is already running, and if so turns it off.
  if [ ! -z "$(ps aux | grep tomcat | grep -v grep)" ]; then
    ${tomcat_location}/bin/shutdown.sh
  fi

  # Remove all the things!
  sudo rm ${tomcat_location}
  rm -r /usr/local/${t_dir}

  # If destroying, stop here.
  if [ "${1}" == "destroy" ]; then
    exit 0
  fi
fi

# Install Tomcat
echo -e "\nInstalling Tomcat v${v}.\n"

target_url="http://apache.mirrors.lucidnetworks.net/tomcat/tomcat-${major_v}/v${v}/bin/${t_file}"
curl -OL ${target_url}
tar -xvf ${t_file}
mv ${t_dir} /usr/local
rm ${t_file}
sudo ln -s /usr/local/${t_dir} ${tomcat_location}
sudo chown -R $(whoami) ${tomcat_location}
sudo chmod +x ${tomcat_location}/bin/*.sh

# Move to logs directory before starting because some libs just dump their logs in pwd
cd ${tomcat_location}/logs
${tomcat_location}/bin/startup.sh

