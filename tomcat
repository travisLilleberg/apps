#!/bin/bash

#@file
#Manages Tomcat


# Settings/Vars
major_v="7" #Defaults to lastest version of 7
minor_v="0.70"
v="${major_v}.${minor_v}"
t_dir="apache-tomcat-${v}"
tomcat_location="/Library/Tomcat"
pid_file="${HOME}/.tomcat_pid"


# Checks
if [ -z $(which java) ]; then
  echo -e "\nYou need to install Java!\n"
  exit 1
fi


# Goooo
case "${1}" in

  # Is Tomcat running?
  'running')
    if [ -f "${pid_file}" ]; then
      echo 1
    else
      echo 0
    fi
    ;;

  'start')
    if [ $($0 running) -eq 0 ]; then
      echo -e "\nStarting Tomcat\n"
      cd ${tomcat_location}/logs
      ${tomcat_location}/bin/startup.sh
    fi
    ;;

  'stop')
    if [ $($0 running) -eq 1 ]; then
      echo -e "\nStopping Tomcat\n"
      ${tomcat_location}/bin/shutdown.sh
    fi
    ;;

  'restart')
    $0 stop
    sleep 3
    $0 start
    ;;

  'install')
    if [ -d "${t_dir}" ]; then
      echo -e "\n${t_dir} already exists!\n"
      exit 1
    fi

    echo -e "\nInstalling Tomcat v${v}.\n"

    t_file="${t_dir}.tar.gz"
    target_url="http://archive.apache.org/dist/tomcat/tomcat-${major_v}/v${v}/bin/${t_file}"
    curl -fOL ${target_url}
    if [ ${?} -gt 0 ]; then
      echo -e "\nFailed to retrieve Tomcat from the web.\n"
      exit 1
    fi

    tar -xvf ${t_file}
    mv ${t_dir} /usr/local
    rm ${t_file}
    sudo ln -s /usr/local/${t_dir} ${tomcat_location}

    sudo chown -R $(whoami) ${tomcat_location}
    sudo chmod +x ${tomcat_location}/bin/*.sh
    echo "CATALINA_PID=${pid_file}" >> ${tomcat_location}/bin/setenv.sh

    $0 start
    ;;

  'destroy')
    echo -e "\nUninstalling Tomcat.\n"

    $0 stop
    sudo rm ${tomcat_location}
    rm -r /usr/local/${t_dir}
    ;;

  'rebuild')
    $0 destroy
    sleep 5
    $0 install
    ;;
esac

