#!/bin/bash

#@file
# Manages Solr 6

# Strappin that boot
this_dir=$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd)
if [ -f ${this_dir}/bootstrap.sh ]; then
  source ${this_dir}/bootstrap.sh
else
  echo -e "\nCouldn't find bootstrap.sh! Ooooh noooo\n"
  exit 1
fi


# Settings/Vars
minor_v="3.0"
v=6.${minor_v}
filename="solr-${v}"
solr_home="/usr/local/solr"
solr_script="${solr_home}/bin/solr"
pid_file="${HOME}/.solr.pid"


#Goooo
case "${1}" in

  # Is Solr running?
  'running')
    if [ -f "${pid_file}" ]; then
      echo 1
    else
      echo 0
    fi
    ;;

  'start')
    if [ $($0 running) -eq 0 ]; then
      neutral_msg "Starting Solr"
      ${solr_script} start
      echo "${!}" > ${pid_file}
    fi
    ;;

  'stop')
    if [ $($0 running) -eq 1 ]; then
      neutral_msg "Stopping Solr"
      ${solr_script} stop
      rm ${pid_file}
    fi
    ;;

  'restart')
    $0 stop
    sleep 3
    $0 start
    ;;

  'install')
    if [ -d "${solr_home}" ]; then
      bad_msg "${solr_home} already exists!"
      exit 1
    fi

    neutral_msg "Installing Solr 6"

    # Get the files
    curl -fOL https://archive.apache.org/dist/lucene/solr/${v}/${filename}.tgz
    if [ ${?} -gt 0 ]; then
      neutral_msg "Failed to retrieve Solr from the web."
      exit 1
    fi

    tar -xf ${filename}.tgz

    # Add solr home
    mv ${filename} ${solr_home}

    # Remove cruft
    rm ${filename}.tgz

    $0 start
    ;;

  'uninstall')
    neutral_msg "Uninstalling Solr 6."

    $0 stop
    sleep 3
    rm -r ${solr_home}
    ;;

  'rebuild')
    $0 uninstall
    sleep 1
    $0 install
    ;;

esac

